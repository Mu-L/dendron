/* eslint-disable import/no-dynamic-require, global-require */
import fs from "fs-extra";
import path from "path";
import * as v from "@badrap/valita";
import { parse } from "./parse";

const noteLiteral = v.literal("note");
const autogeneratedLiteral = v.literal("autogenerated");
const categoryLiteral = v.literal("category");

const sidebarItemNote = v.object({
  type: noteLiteral,
  id: v.string(),
  label: v.string(),
});

// type SidebarItemNote = z.infer<typeof sidebarItemNote>

const sidebarItemAutogenerated = v.object({
  type: autogeneratedLiteral,
  id: v.string(),
});

// type SidebarItemAutogenerated = z.infer<typeof sidebarItemAutogenerated>

const sidebarItemCategoryLinkNote = v.object({
  type: noteLiteral,
  id: v.string(),
});

type SidebarItemCategory = {
  type: "category";
  label: string;
  items: SidebarItem[];
};

const sidebarItemCategory: v.Type<SidebarItemCategory> = v.lazy(() =>
  v.object({
    type: categoryLiteral,
    label: v.string(),
    items: v.array(v.lazy(() => sidebarItem)),
    link: sidebarItemCategoryLinkNote,
  })
);

const sidebarItem = v.union(
  sidebarItemCategory,
  sidebarItemNote,
  sidebarItemAutogenerated
);

type SidebarItem = v.Infer<typeof sidebarItem>;

const sidebars = v.record(v.array(sidebarItem));

// type Sidebar = v.Infer<typeof sidebarItem>;
type Sidebars = v.Infer<typeof sidebars>;

export const DefaultSidebars: Sidebars = {
  defaultSidebar: [
    {
      type: "autogenerated",
      id: ".",
    },
  ],
};

export const DisabledSidebars: Sidebars = {};

async function loadSidebarsFile(
  sidebarFilePath: string | false | undefined
): Promise<unknown> {
  // false => no sidebars
  if (sidebarFilePath === false) {
    return DisabledSidebars;
  }

  // undefined => defaults to autogenerated sidebars
  if (typeof sidebarFilePath === "undefined") {
    return DefaultSidebars;
  }

  // Non-existent sidebars file: no sidebars
  if (!(await fs.pathExists(sidebarFilePath))) {
    return DisabledSidebars;
  }

  return require(path.resolve(sidebarFilePath));
}

export async function loadSidebars(
  sidebarFilePath: string | false | undefined
) {
  const sidebarsConfig = await loadSidebarsFile(sidebarFilePath);
  return parse(sidebars, sidebarsConfig);
}
